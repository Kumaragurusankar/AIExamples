class AppState(State):
    query: str
    structured: dict
    results: list
    final_results: list

initial_state = AppState(
    query=user_query,
    structured={},
    results=[],
    final_results=[]
)

# 6. LangGraph Nodes with safe state updates
def interpret_prompt_node(state: AppState) -> AppState:
    query = state.query
    structured = llm_chain.run(query)
    try:
        structured_dict = json.loads(structured)
    except:
        structured_dict = {}
    return state.copy(update={"structured": structured_dict})

def search_faiss_node(state: AppState) -> AppState:
    structured_dict = state.structured
    query_text = json.dumps(structured_dict)
    query_embedding = get_embedding(query_text)
    D, I = index.search(np.array([query_embedding]).astype('float32'), k=5)
    matches = [flat_texts[i] for i in I[0]]
    return state.copy(update={"results": matches})

def return_results_node(state: AppState) -> AppState:
    return state.copy(update={"final_results": state.results})



--------------


from typing import TypedDict

class AppState(TypedDict):
    query: str
    structured: dict
    results: list
    final_results: list

def interpret_prompt_node(state: AppState) -> AppState:
    query = state["query"]
    structured = llm_chain.run(query)
    try:
        structured_dict = json.loads(structured)
    except:
        structured_dict = {}
    return {**state, "structured": structured_dict}

def search_faiss_node(state: AppState) -> AppState:
    structured_dict = state["structured"]
    query_text = json.dumps(structured_dict)
    query_embedding = get_embedding(query_text)
    D, I = index.search(np.array([query_embedding]).astype('float32'), k=5)
    matches = [flat_texts[i] for i in I[0]]
    return {**state, "results": matches}

def return_results_node(state: AppState) -> AppState:
    return {**state, "final_results": state["results"]}


initial_state: AppState = {
    "query": user_query,
    "structured": {},
    "results": [],
    "final_results": []
}

------------------------------------------------
def filter_results_node(state):
    query = state["query"]
    candidates = state["results"]
    response = refine_chain.run({
        "query": query,
        "candidates": json.dumps(candidates, indent=2)
    })
    return {"final_output": response}


graph.add_node("FilterResults", filter_results_node)
graph.add_edge("ReturnResults", "FilterResults")
graph.set_finish_point("FilterResults")

result["final_output"]
